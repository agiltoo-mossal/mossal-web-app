<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

<div style="display: flex; gap: 5px; color: #11167a; font-size: 16px">
    <a routerLink="/dashboard/society"><span>{{ "<" }}</span>retour</a>
</div>

<h2 class="container-title-setting">
    <span>{{ title }}</span>
</h2>

<div class="creation-compte">
    <form class="form" [formGroup]="societyForm" (ngSubmit)="submitForm()">
        <!-- Section Informations de la société -->
        <div class="form-section">
            <h3 class="section-title">Informations de la société</h3>

            <!-- Logo Upload Section avec affichage du logo existant -->
            <div class="form-row">
                <div class="form-group logo-upload-group">
                    <div class="logo-upload-container">
                        <!-- Logo preview - existant ou nouveau -->
                        <div class="logo-preview" [class.has-logo]="hasLogo()">

                            <!-- Affichage du logo existant (Base64) -->
                            <img *ngIf="existingLogoData && !logoPreview"
                                [src]="'data:' + existingLogoMimeType + ';base64,' + existingLogoData" alt="Logo actuel"
                                class="logo-image existing-logo">

                            <!-- Affichage du nouveau logo en prévisualisation -->
                            <img *ngIf="logoPreview" [src]="logoPreview" alt="Nouveau logo" class="logo-image new-logo">

                            <!-- Placeholder si aucun logo -->
                            <div *ngIf="!hasLogo()" class="logo-placeholder">
                                <span class="material-icons">business</span>
                            </div>
                        </div>
                        <!-- Upload button -->
                        <div class="logo-upload-actions">
                            <button fxLayout="row" fxLayoutAlign="center center" type="button"
                                class="logo-upload-button" (click)="triggerLogoUpload()">
                                <span class="material-icons">cloud_upload</span>
                                <span>
                                    {{ hasLogo() ? 'Changer le logo' : 'Télécharger le logo de l\'entreprise' }}
                                </span>
                            </button>

                            <!-- Bouton supprimer (nouveau logo ou logo existant) -->
                            <button type="button" *ngIf="selectedFiles?.logo || existingLogoData"
                                class="logo-remove-button" (click)="removeLogo()">
                                Supprimer
                            </button>
                        </div>

                        <!-- Hidden file input -->
                        <input type="file" #logoFileInput id="logo-file" accept="image/*"
                            (change)="onFileSelect($event, 'logo')" style="display: none;">
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="entreprise" class="required">Entreprise</label>
                    <input type="text" id="companyName" formControlName="companyName" placeholder="Agiltoo" required />
                    <div *ngIf="societyForm.get('companyName')?.invalid &&
                                    societyForm.get('companyName')?.touched" class="error-message">
                        <span *ngIf="societyForm.get('companyName')?.errors?.['required']">Le nom de la société
                            est obligatoire.</span>
                    </div>
                </div>
            </div>

            <div class="form-row two-cols">
                <div class="form-group">
                    <label for="address" class="required">Adresse postale</label>
                    <input type="text" id="address" formControlName="address" placeholder="Ouest-Foire" required />
                    <div *ngIf="societyForm.get('address')?.invalid &&
                                societyForm.get('address')?.touched" class="error-message">
                        <span *ngIf="societyForm.get('address')?.errors?.['required']">L'adresse postale
                            est obligatoire.</span>
                    </div>
                </div>
                <div class="form-group">
                    <input type="text" name="city" formControlName="city" placeholder="Dakar - Sénégal"
                        style="margin-top: 28px;" />
                    <div *ngIf="societyForm.get('city')?.invalid &&
                                societyForm.get('city')?.touched" class="error-message">
                        <span *ngIf="societyForm.get('city')?.errors?.['required']">L'adresse postale
                            est obligatoire.</span>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="telephone-entreprise">téléphone</label>
                    <input type="tel" id="phone" formControlName="phone" placeholder="+221 770000000" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="ninea-file">NINEA</label>
                    <div class="file-upload-container">
                        <input type="file" id="ninea" accept=".pdf" (change)="onFileSelect($event, 'ninea')"
                            style="display: none;" #nineaFileInput />
                        <div class="file-upload-display" (click)="nineaFileInput.click()">
                            <span class="material-icons">upload_file</span>
                            <span class="file-name">
                                {{ selectedFiles?.ninea?.name || 'NINEA_Agiltoo.pdf' }}
                            </span>
                            <span class="material-icons upload-icon">cloud_upload</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="psp" class="required">Partenaire de Service de Paiement</label>
                    <select id="psp" name="psp" formControlName="psp">
                        <option value="">Sélectionner le partenaire de paiement</option>
                        <option *ngFor="let psp of psps" [value]="psp.id">{{ psp.name }}</option>
                    </select>
                    <div *ngIf="societyForm.get('psp')?.invalid &&
                                societyForm.get('psp')?.touched" class="error-message">
                        <span *ngIf="societyForm.get('psp')?.errors?.['required']">Selectionner un partenaire de
                            paiement.</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Informations du super admin -->
        <div class="form-section">
            <h3 class="section-title">Informations du super admin</h3>

            <div class="form-row two-cols">
                <div class="form-group">
                    <label for="nom-admin" class="required">Nom</label>
                    <input type="text" id="adminLastName" formControlName="adminLastName" placeholder="Sall" />
                    <div *ngIf="societyForm.get('adminLastName')?.invalid &&
                                societyForm.get('adminLastName')?.touched" class="error-message">
                        <span *ngIf="societyForm.get('adminLastName')?.errors?.['required']">Le nom de l'admin
                            est obligatoire.</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="prenom-admin" class="required">Prénom</label>
                    <input type="text" id="adminFirstName" formControlName="adminFirstName" placeholder="Omar" />
                    <div *ngIf="societyForm.get('adminFirstName')?.invalid &&
                                societyForm.get('adminFirstName')?.touched" class="error-message">
                        <span *ngIf="societyForm.get('adminFirstName')?.errors?.['required']">Le prénom de l'admin
                            est obligatoire.</span>
                    </div>
                </div>
            </div>

            <div class="form-row two-cols">
                <div class="form-group">
                    <label for="fonction" class="required">Fonction</label>
                    <input type="text" id="adminFunction" formControlName="adminFunction" placeholder="Directeur" />
                    <div *ngIf="societyForm.get('adminFunction')?.invalid &&
                                societyForm.get('adminFunction')?.touched" class="error-message">
                        <span *ngIf="societyForm.get('adminFunction')?.errors?.['required']">La fonction de l'admin
                            est obligatoire.</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="telephone-admin" class="required">Numéro téléphone</label>
                    <input type="tel" id="adminPhone" formControlName="adminPhone" placeholder="+221770000000" />
                    <div *ngIf="societyForm.get('adminPhone')?.invalid &&
                                societyForm.get('adminPhone')?.touched" class="error-message">
                        <span *ngIf="societyForm.get('adminPhone')?.errors?.['required']">Le numéro de téléphone
                            est obligatoire.</span>
                        <span *ngIf="societyForm.get('adminPhone')?.errors?.['pattern']">Entrez un numéro au
                            format +221XXXXXXXXX.</span>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="email-admin" class="required">Adresse mail du super admin</label>
                    <input type="email" id="adminEmail" formControlName="adminEmail" placeholder="contact@agiltoo.fr" />
                    <div *ngIf="societyForm.get('adminEmail')?.invalid && societyForm.get('adminEmail')?.touched
                            " class="error-message">
                        <span *ngIf="societyForm.get('adminEmail')?.errors?.['required']">L'adresse mail est
                            obligatoire.</span>
                        <span *ngIf="societyForm.get('adminEmail')?.errors?.['adminEmail']">Entrez une adresse mail
                            valide.</span>
                        <span *ngIf="adminEmailExists">Adresse email déjà utilisé</span>

                    </div>
                </div>
            </div>
        </div>

        <!-- Boutons -->
        <div class="form-buttons">
            <button type="submit" class="submit-button" [disabled]="isLoading">
                <span *ngIf="isLoading" class="loading-spinner"></span>
                {{ isLoading ? 'Enregistrement...' : 'Enregistrer' }}
            </button>
        </div>
    </form>
</div>